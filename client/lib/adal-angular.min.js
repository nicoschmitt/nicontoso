!function(){"use strict";if("undefined"!=typeof module&&module.exports&&(module.exports.inject=function(e){return new AuthenticationContext(e)}),angular){var e=angular.module("AdalAngular",[]);e.provider("adalAuthenticationService",function(){var e=null,r={isAuthenticated:!1,userName:"",loginError:"",profile:""},t=function(t){var n=e.getCachedToken(t);r.isAuthenticated=null!==n&&n.length>0;var o=e.getCachedUser()||{userName:""};r.userName=o.userName,r.profile=o.profile,r.loginError=e.getLoginError()};this.init=function(r,n){if(!r)throw new Error("You must set configOptions, when calling init");var o=window.location.hash,i=window.location.href;o&&(i=i.replace(o,"")),r.redirectUri=r.redirectUri||i,r.postLogoutRedirectUri=r.postLogoutRedirectUri||i,r.isAngular=!0,n&&n.interceptors&&n.interceptors.push("ProtectedResourceInterceptor"),e=new AuthenticationContext(r),t(e.config.loginResource)},this.$get=["$rootScope","$window","$q","$location","$timeout","$injector",function(n,o,i,a,c,u){function s(e,r){return r.requireADLogin?e.requireADLogin!==!1:!!e.requireADLogin}function l(r){if(e.config&&e.config.anonymousEndpoints)for(var t=0;t<e.config.anonymousEndpoints.length;t++)if(r.indexOf(e.config.anonymousEndpoints[t])>-1)return!0;return!1}function f(e){var r=null,t=[];if(e.hasOwnProperty("parent"))for(r=e;r;)t.unshift(r),r=u.get("$state").get(r.parent);else for(var n=e.name.split("."),o=0,i=n[0];o<n.length;o++)r=u.get("$state").get(i),r&&t.push(r),i+="."+n[o+1];return t}var g=function(i,s,l){e.verbose("Location change event from "+l+" to "+s);var f=o.location.hash;if(e.isCallback(f)){e.verbose("Processing the hash: "+f);var g=e.getRequestInfo(f);if(e.saveTokenFromHash(g),g.stateMatch){if(g.requestType===e.REQUEST_TYPE.RENEW_TOKEN){var d=o.parent.callBackMappedToRenewStates[g.stateResponse];if(i.preventDefault(),d&&"function"==typeof d){if(g.parameters.access_token)return void d(e._getItem(e.CONSTANTS.STORAGE.ERROR_DESCRIPTION),g.parameters.access_token,e._getItem(e.CONSTANTS.STORAGE.ERROR));if(g.parameters.id_token)return void d(e._getItem(e.CONSTANTS.STORAGE.ERROR_DESCRIPTION),g.parameters.id_token,e._getItem(e.CONSTANTS.STORAGE.ERROR));if(g.parameters.error)return void d(e._getItem(e.CONSTANTS.STORAGE.ERROR_DESCRIPTION),null,e._getItem(e.CONSTANTS.STORAGE.ERROR))}}else if(g.requestType===e.REQUEST_TYPE.LOGIN)if(t(e.config.loginResource),r.userName?(c(function(){t(e.config.loginResource),n.userInfo=r},1),n.$broadcast("adal:loginSuccess",e._getItem(e.CONSTANTS.STORAGE.IDTOKEN))):n.$broadcast("adal:loginFailure",e._getItem(e.CONSTANTS.STORAGE.ERROR_DESCRIPTION),e._getItem(e.CONSTANTS.STORAGE.ERROR)),e.callback&&"function"==typeof e.callback&&e.callback(e._getItem(e.CONSTANTS.STORAGE.ERROR_DESCRIPTION),e._getItem(e.CONSTANTS.STORAGE.IDTOKEN),e._getItem(e.CONSTANTS.STORAGE.ERROR)),e.popUp)i.preventDefault();else{var R=e._getItem(e.CONSTANTS.STORAGE.LOGIN_REQUEST);"undefined"!=typeof R&&R&&0!==R.length&&(e.verbose("Redirecting to start page: "+R),!a.$$html5&&R.indexOf("#")>-1&&a.url(R.substring(R.indexOf("#")+1)),o.location=R)}}else n.$broadcast("adal:stateMismatch",e._getItem(e.CONSTANTS.STORAGE.ERROR_DESCRIPTION),e._getItem(e.CONSTANTS.STORAGE.ERROR))}else if(t(e.config.loginResource),!r.isAuthenticated&&r.userName&&!e._renewActive){var p=u.get("adalAuthenticationService");p.acquireToken(e.config.loginResource).then(function(e){e&&(r.isAuthenticated=!0)},function(e){var r=e.split("|");n.$broadcast("adal:loginFailure",r[0],r[1])})}c(function(){t(e.config.loginResource),n.userInfo=r},1)},d=function(){e.info("Login event for:"+a.$$url),e.config&&e.config.localLoginUrl?a.path(e.config.localLoginUrl):(e.info("Start login at:"+window.location.href),n.$broadcast("adal:loginRedirect"),e.login())},R=function(t,n){if(n&&n.$$route)if(s(n.$$route,e.config))r.isAuthenticated||e._renewActive||e.loginInProgress()||(e.info("Route change event for:"+a.$$url),d());else{var o;o="function"==typeof n.$$route.templateUrl?n.$$route.templateUrl(n.params):n.$$route.templateUrl,o&&!l(o)&&e.config.anonymousEndpoints.push(o)}},p=function(t,n,o,i,c){if(n)for(var u=f(n),g=null,R=0;R<u.length;R++)if(g=u[R],s(g,e.config))r.isAuthenticated||e._renewActive||e.loginInProgress()||(e.info("State change event for:"+a.$$url),d());else if(g.templateUrl){var p;p="function"==typeof g.templateUrl?g.templateUrl(o):g.templateUrl,p&&!l(p)&&e.config.anonymousEndpoints.push(p)}},h=function(r,t,n,o,i,a){e.verbose("State change error occured. Error: "+JSON.stringify(a)),a&&a.data&&(e.info("Setting defaultPrevented to true if state change error occured because adal rejected a request. Error: "+a.data),r.preventDefault())};return n.$on("$routeChangeStart",R),n.$on("$stateChangeStart",p),n.$on("$locationChangeStart",g),n.$on("$stateChangeError",h),t(e.config.loginResource),n.userInfo=r,{config:e.config,login:function(){e.login()},loginInProgress:function(){return e.loginInProgress()},logOut:function(){e.logOut()},getCachedToken:function(r){return e.getCachedToken(r)},userInfo:r,acquireToken:function(r){var t=i.defer();return e._renewActive=!0,e.acquireToken(r,function(o,i,a){e._renewActive=!1,a?(n.$broadcast("adal:acquireTokenFailure",o,a),e.error("Error when acquiring token for resource: "+r,a),t.reject(o+"|"+a)):(n.$broadcast("adal:acquireTokenSuccess",i),t.resolve(i))}),t.promise},getUser:function(){var r=i.defer();return e.getUser(function(t,n){t?(e.error("Error when getting user",t),r.reject(t)):r.resolve(n)}),r.promise},getResourceForEndpoint:function(r){return e.getResourceForEndpoint(r)},clearCache:function(){e.clearCache()},clearCacheForResource:function(r){e.clearCacheForResource(r)},info:function(r){e.info(r)},verbose:function(r){e.verbose(r)}}}]}),e.factory("ProtectedResourceInterceptor",["adalAuthenticationService","$q","$rootScope",function(e,r,t){return{request:function(n){if(n){n.headers=n.headers||{};var o=e.getResourceForEndpoint(n.url);if(e.verbose("Url: "+n.url+" maps to resource: "+o),null===o)return n;var i=e.getCachedToken(o);if(i)return e.info("Token is available for this url "+n.url),n.headers.Authorization="Bearer "+i,n;if(e.loginInProgress()){if(e.config.popUp){e.info("Url: "+n.url+" will be loaded after login is successful");var a=r.defer();return t.$on("adal:loginSuccess",function(r,t){t&&(e.info("Login completed, sending request for "+n.url),n.headers.Authorization="Bearer "+i,a.resolve(n))}),a.promise}return e.info("login is in progress."),n.data="login in progress, cancelling the request for "+n.url,r.reject(n)}var a=r.defer();return e.acquireToken(o).then(function(r){e.verbose("Token is available"),n.headers.Authorization="Bearer "+r,a.resolve(n)},function(e,r){n.data=e+"|"+r,a.reject(n)}),a.promise}},responseError:function(n){if(e.info("Getting error in the response: "+JSON.stringify(n)),n){if(401===n.status){var o=e.getResourceForEndpoint(n.config.url);e.clearCacheForResource(o),t.$broadcast("adal:notAuthorized",n,o)}else t.$broadcast("adal:errorResponse",n);return r.reject(n)}}}}])}else console.error("Angular.JS is not included")}();