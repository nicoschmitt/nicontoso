!function(){"use strict";if("undefined"!=typeof module&&module.exports&&(module.exports.inject=function(e){return new AuthenticationContext(e)}),angular){var e=angular.module("AdalAngular",[]);e.provider("adalAuthenticationService",function(){var e=null,r={isAuthenticated:!1,userName:"",loginError:"",profile:""},n=function(n){var o=e.getCachedToken(n);r.isAuthenticated=null!==o&&o.length>0;var t=e.getCachedUser()||{userName:""};r.userName=t.userName,r.profile=t.profile,r.loginError=e.getLoginError()};this.init=function(r,o){if(!r)throw new Error("You must set configOptions, when calling init");var t=window.location.hash,i=window.location.href;t&&(i=i.replace(t,"")),r.redirectUri=r.redirectUri||i,r.postLogoutRedirectUri=r.postLogoutRedirectUri||i,o&&o.interceptors&&o.interceptors.push("ProtectedResourceInterceptor"),e=new AuthenticationContext(r),n(e.config.loginResource)},this.$get=["$rootScope","$window","$q","$location","$timeout",function(o,t,i,a,c){function u(e,r){return r.requireADLogin?e.requireADLogin!==!1:!!e.requireADLogin}function s(r){if(e.config&&e.config.anonymousEndpoints)for(var n=0;n<e.config.anonymousEndpoints.length;n++)if(r.indexOf(e.config.anonymousEndpoints[n])>-1)return!0;return!1}var l=function(i,u,s){e.verbose("Location change event from "+s+" to "+u);var l=t.location.hash;if(e.isCallback(l)){e.verbose("Processing the hash: "+l);var f=e.getRequestInfo(l);if(e.saveTokenFromHash(f),f.requestType!==e.REQUEST_TYPE.LOGIN&&(e.callback=t.parent.AuthenticationContext().callback,f.requestType===e.REQUEST_TYPE.RENEW_TOKEN&&(e.callback=t.parent.callBackMappedToRenewStates[f.stateResponse])),f.stateMatch)if("function"==typeof e.callback){if(i.preventDefault(),f.requestType===e.REQUEST_TYPE.RENEW_TOKEN){if(f.parameters.access_token)return void e.callback(e._getItem(e.CONSTANTS.STORAGE.ERROR_DESCRIPTION),f.parameters.access_token);if(f.parameters.id_token)return void e.callback(e._getItem(e.CONSTANTS.STORAGE.ERROR_DESCRIPTION),f.parameters.id_token);if(f.parameters.error)return void e.callback(e._getItem(e.CONSTANTS.STORAGE.ERROR_DESCRIPTION),null)}}else{n(e.config.loginResource),r.userName?(c(function(){n(e.config.loginResource),o.userInfo=r},1),o.$broadcast("adal:loginSuccess")):o.$broadcast("adal:loginFailure",e._getItem(e.CONSTANTS.STORAGE.ERROR_DESCRIPTION));var g=e._getItem(e.CONSTANTS.STORAGE.LOGIN_REQUEST);g&&(e.verbose("Redirecting to start page: "+g),i.preventDefault(),!a.$$html5&&g.indexOf("#")>-1&&a.url(g.substring(g.indexOf("#")+1)),t.location=g)}else o.$broadcast("adal:stateMismatch",e._getItem(e.CONSTANTS.STORAGE.ERROR_DESCRIPTION))}else n(e.config.loginResource),r.isAuthenticated||!r.userName||e._renewActive||(e._renewActive=!0,e.acquireToken(e.config.loginResource,function(n,t){e._renewActive=!1,n?o.$broadcast("adal:loginFailure","auto renew failure"):t&&(r.isAuthenticated=!0)}));c(function(){n(e.config.loginResource),o.userInfo=r},1)},f=function(){e.info("Login event for:"+a.$$url),e.config&&e.config.localLoginUrl?a.path(e.config.localLoginUrl):(e.info("Start login at:"+window.location.href),o.$broadcast("adal:loginRedirect"),e.login())},g=function(n,o){o&&o.$$route&&(u(o.$$route,e.config)?r.isAuthenticated||e._renewActive||e.loginInProgress()||(e.info("Route change event for:"+a.$$url),f()):o.$$route.templateUrl&&!s(o.$$route.templateUrl)&&e.config.anonymousEndpoints.push(o.$$route.templateUrl))},d=function(n,o,t,i,c){o&&(u(o,e.config)?r.isAuthenticated||e._renewActive||e.loginInProgress()||(e.info("State change event for:"+a.$$url),f()):o.templateUrl&&!s(o.templateUrl)&&e.config.anonymousEndpoints.push(o.templateUrl))},h=function(r,n,o,t,i,a){e.verbose("State change error occured. Error: "+a),a&&a.data&&(e.info("Setting defaultPrevented to true if state change error occured because adal rejected a request. Error: "+a.data),r.preventDefault())};return o.$on("$routeChangeStart",g),o.$on("$stateChangeStart",d),o.$on("$locationChangeStart",l),o.$on("$stateChangeError",h),n(e.config.loginResource),o.userInfo=r,{config:e.config,login:function(){f()},loginInProgress:function(){return e.loginInProgress()},logOut:function(){e.logOut()},getCachedToken:function(r){return e.getCachedToken(r)},userInfo:r,acquireToken:function(r){var n=i.defer();return e._renewActive=!0,e.acquireToken(r,function(o,t){e._renewActive=!1,o?(e.error("Error when acquiring token for resource: "+r,o),n.reject(o)):n.resolve(t)}),n.promise},getUser:function(){var r=i.defer();return e.getUser(function(n,o){n?(e.error("Error when getting user",n),r.reject(n)):r.resolve(o)}),r.promise},getResourceForEndpoint:function(r){return e.getResourceForEndpoint(r)},clearCache:function(){e.clearCache()},clearCacheForResource:function(r){e.clearCacheForResource(r)},info:function(r){e.info(r)},verbose:function(r){e.verbose(r)}}}]}),e.factory("ProtectedResourceInterceptor",["adalAuthenticationService","$q","$rootScope",function(e,r,n){return{request:function(n){if(n){n.headers=n.headers||{};var o=e.getResourceForEndpoint(n.url);if(e.verbose("Url: "+n.url+" maps to resource: "+o),null===o)return n;var t=e.getCachedToken(o);if(t)return e.info("Token is available for this url "+n.url),n.headers.Authorization="Bearer "+t,n;if(e.loginInProgress())return e.info("login is in progress."),n.data="login in progress, cancelling the request for "+n.url,r.reject(n);var i=r.defer();return e.acquireToken(o).then(function(r){e.verbose("Token is available"),n.headers.Authorization="Bearer "+r,i.resolve(n)},function(e){n.data=e,i.reject(n)}),i.promise}},responseError:function(o){if(e.info("Getting error in the response."),o){if(401===o.status){var t=e.getResourceForEndpoint(o.config.url);e.clearCacheForResource(t),n.$broadcast("adal:notAuthorized",o,t)}else n.$broadcast("adal:errorResponse",o);return r.reject(o)}}}}])}else console.error("Angular.JS is not included")}();