!function(){"use strict";if("undefined"!=typeof module&&module.exports&&(module.exports.inject=function(e){return new AuthenticationContext(e)}),angular){var e=angular.module("AdalAngular",[]);e.provider("adalAuthenticationService",function(){var e=null,r={isAuthenticated:!1,userName:"",loginError:"",profile:""},n=function(n){var t=e.getCachedToken(n);r.isAuthenticated=null!==t&&t.length>0;var o=e.getCachedUser()||{userName:""};r.userName=o.userName,r.profile=o.profile,r.loginError=e.getLoginError()};this.init=function(r,t){if(!r)throw new Error("You must set configOptions, when calling init");r.isAngular=!0,t&&t.interceptors&&t.interceptors.push("ProtectedResourceInterceptor"),e=new AuthenticationContext(r),n(e.config.loginResource)},this.$get=["$rootScope","$window","$q","$location","$timeout","$injector",function(t,o,i,a,c,u){function s(e,r){return r.requireADLogin?!1!==e.requireADLogin:!!e.requireADLogin}function l(r){if(e.config&&e.config.anonymousEndpoints)for(var n=0;n<e.config.anonymousEndpoints.length;n++)if(r.indexOf(e.config.anonymousEndpoints[n])>-1)return!0;return!1}function f(e){var r=null,n=[];if(e.hasOwnProperty("parent"))for(r=e;r;)n.unshift(r),r=u.get("$state").get(r.parent);else for(var t=e.name.split("."),o=0,i=t[0];o<t.length;o++)(r=u.get("$state").get(i))&&n.push(r),i+="."+t[o+1];return n}var g=function(o,i,u){if(e.verbose("Location change event from "+u+" to "+i),a.$$html5)s=a.hash();else var s="#"+a.path();d(s,o),c(function(){n(e.config.loginResource),t.userInfo=r},1)},d=function(i,s){if(e.isCallback(i)){e.verbose("Processing the hash: "+i);var l=e.getRequestInfo(i);if(e.saveTokenFromHash(l),l.stateMatch){if(l.requestType===e.REQUEST_TYPE.RENEW_TOKEN){e._renewActive=!1;var f=o.parent.callBackMappedToRenewStates[l.stateResponse]||e.callback;if(s&&s.preventDefault&&window.parent!==window&&s.preventDefault(),f&&"function"==typeof f){var g=l.parameters.access_token||l.parameters.id_token,d=l.parameters.error,p=l.parameters.error_description;if(o.parent!==o||o.parent.callBackMappedToRenewStates[l.stateResponse]||(g?t.$broadcast("adal:acquireTokenSuccess",g):d&&p&&t.$broadcast("adal:acquireTokenFailure",d,p)),f(p,g,d),window.parent!==window)return}}else l.requestType===e.REQUEST_TYPE.LOGIN&&(n(e.config.loginResource),r.userName?(c(function(){n(e.config.loginResource),t.userInfo=r},1),t.$broadcast("adal:loginSuccess",e._getItem(e.CONSTANTS.STORAGE.IDTOKEN))):t.$broadcast("adal:loginFailure",e._getItem(e.CONSTANTS.STORAGE.ERROR_DESCRIPTION),e._getItem(e.CONSTANTS.STORAGE.ERROR)),e.callback&&"function"==typeof e.callback&&e.callback(e._getItem(e.CONSTANTS.STORAGE.ERROR_DESCRIPTION),e._getItem(e.CONSTANTS.STORAGE.IDTOKEN),e._getItem(e.CONSTANTS.STORAGE.ERROR)));if(!e.popUp&&window.parent===window)if(e.config.navigateToLoginRequestUrl){var h=e._getItem(e.CONSTANTS.STORAGE.LOGIN_REQUEST);void 0!==h&&h&&0!==h.length&&(e.verbose("Redirecting to start page: "+h),!a.$$html5&&h.indexOf("#")>-1&&a.url(h.substring(h.indexOf("#")+1)),o.location.href=h)}else a.$$html5?a.hash(""):a.path("")}else t.$broadcast("adal:stateMismatch",e._getItem(e.CONSTANTS.STORAGE.ERROR_DESCRIPTION),e._getItem(e.CONSTANTS.STORAGE.ERROR))}else n(e.config.loginResource),r.isAuthenticated||!r.userName||e._renewActive||u.get("adalAuthenticationService").acquireToken(e.config.loginResource).then(function(e){e&&(r.isAuthenticated=!0)},function(e){var r=e.split("|");t.$broadcast("adal:loginFailure",r[0],r[1])})},p=function(){e.info("Login event for:"+a.$$url),e.config&&e.config.localLoginUrl?a.path(e.config.localLoginUrl):(e.info("Start login at:"+a.$$absUrl),t.$broadcast("adal:loginRedirect"),e.login(a.$$absUrl))},h=function(n,t){if(t&&t.$$route)if(s(t.$$route,e.config))r.isAuthenticated||e._renewActive||e.loginInProgress()||(e.info("Route change event for:"+a.$$url),p());else{var o;(o="function"==typeof t.$$route.templateUrl?t.$$route.templateUrl(t.params):t.$$route.templateUrl)&&!l(o)&&e.config.anonymousEndpoints.push(o)}},T=function(n,t,o,i,c){if(t)for(var u=f(t),g=null,d=0;d<u.length;d++)if(g=u[d],s(g,e.config))r.isAuthenticated||e._renewActive||e.loginInProgress()||(e.info("State change event for:"+a.$$url),p());else if(g.templateUrl){var h;(h="function"==typeof g.templateUrl?g.templateUrl(o):g.templateUrl)&&!l(h)&&e.config.anonymousEndpoints.push(h)}},R=function(r,n,t,o,i,a){e.verbose("State change error occured. Error: "+JSON.stringify(a)),a&&a.data&&(e.info("Setting defaultPrevented to true if state change error occured because adal rejected a request. Error: "+a.data),r.preventDefault())};return t.$on("$routeChangeStart",h),t.$on("$stateChangeStart",T),t.$on("$locationChangeStart",g),t.$on("$stateChangeError",R),o.addEventListener("adal:popUpHashChanged",function(e){d(e.detail)}),n(e.config.loginResource),t.userInfo=r,{config:e.config,login:function(){e.login()},loginInProgress:function(){return e.loginInProgress()},logOut:function(){e.logOut()},getCachedToken:function(r){return e.getCachedToken(r)},userInfo:r,acquireToken:function(r){var n=i.defer();return e._renewActive=!0,e.acquireToken(r,function(o,i,a){e._renewActive=!1,a?(t.$broadcast("adal:acquireTokenFailure",o,a),e.error("Error when acquiring token for resource: "+r,a),n.reject(o+"|"+a)):(t.$broadcast("adal:acquireTokenSuccess",i),n.resolve(i))}),n.promise},acquireTokenPopup:function(r,n,o){var a=i.defer();return e.acquireTokenPopup(r,n,o,function(n,o,i){i?(t.$broadcast("adal:acquireTokenFailure",n,i),e.error("Error when acquiring token for resource: "+r,i),a.reject(n+"|"+i)):(t.$broadcast("adal:acquireTokenSuccess",o),a.resolve(o))}),a.promise},acquireTokenRedirect:function(r,n,t){e.acquireTokenRedirect(r,n,t)},getUser:function(){var r=i.defer();return e.getUser(function(n,t){n?(e.error("Error when getting user",n),r.reject(n)):r.resolve(t)}),r.promise},getResourceForEndpoint:function(r){return e.getResourceForEndpoint(r)},clearCache:function(){e.clearCache()},clearCacheForResource:function(r){e.clearCacheForResource(r)},info:function(r){e.info(r)},verbose:function(r){e.verbose(r)}}}]}),e.factory("ProtectedResourceInterceptor",["adalAuthenticationService","$q","$rootScope","$templateCache",function(e,r,n,t){return{request:function(o){if(o){if(o.headers=o.headers||{},t.get(o.url))return o;var i=e.getResourceForEndpoint(o.url);if(e.verbose("Url: "+o.url+" maps to resource: "+i),null===i)return o;var a=e.getCachedToken(i);if(a)return e.info("Token is available for this url "+o.url),o.headers.Authorization="Bearer "+a,o;if(e.loginInProgress()){if(e.config.popUp){e.info("Url: "+o.url+" will be loaded after login is successful");c=r.defer();return n.$on("adal:loginSuccess",function(r,n){n&&(e.info("Login completed, sending request for "+o.url),o.headers.Authorization="Bearer "+a,c.resolve(o))}),c.promise}return e.info("login is in progress."),o.data="login in progress, cancelling the request for "+o.url,r.reject(o)}var c=r.defer();return e.acquireToken(i).then(function(r){e.verbose("Token is available"),o.headers.Authorization="Bearer "+r,c.resolve(o)},function(e){o.data=e,c.reject(o)}),c.promise}},responseError:function(t){if(e.info("Getting error in the response: "+JSON.stringify(t)),t){if(401===t.status){var o=e.getResourceForEndpoint(t.config.url);e.clearCacheForResource(o),n.$broadcast("adal:notAuthorized",t,o)}else n.$broadcast("adal:errorResponse",t);return r.reject(t)}}}}])}else console.error("Angular.JS is not included")}();